{% extends 'base.html' %}
{% load static %}

{% block title %}{{ blog.title }}{% endblock %}
{% block css %}
    <link rel="stylesheet" href="{% static 'css/blog_page.css' %}">
{% endblock %}
{% block content %}

    <div class="container">
        <h2 class="blog-title">{{ blog.title }}</h2>
        <br>

        <div class="userbar">
            <div class="fl">
                <span class="utime">{{ blog.ctime |date:"Y年m月d日 H:i:s"}}</span>

            </div>
            <div class="fr text-primary"> {{ blog.rcount }} 阅读</div>

        </div>
        <br>
        <br>
        <div class="blog">
            {{ blog.content|safe }}
        </div>


        <span class="">个人分类：<a class="marks" href="{% url 'blog:marks' blog.marks %}">{{ blog.marks }}</a></span>
        {#        需要加个判断，不能给自己的文章点赞#}
        {% ifequal blog.uname_id request.user.username %}
            <span class="pull-right text-primary">已{{ blog.like }}个赞啦 </span>
            {% else %}
            <a class="pull-right" id="likes" href="javascript:void(0);"> 点赞</a>
            <span id="zan" class="pull-right">{{ blog.like }} </span>

            <script>
                $(function () {
                    $('#likes').click(function () {
                        $.ajax({
                            type: "get",
                            url: "{% url 'blog:ulike' blog.id %}",

                            async: true,
                            success: function (data) {
                                //1没有点赞，2点过赞

                                if (data == '1') {
                                    $('#zan').text(parseInt({{ blog.like }}) + 1);

                                }
                                if (data == '2') {
                                    {#$("#likes").innerText="已赞";#}
                                    alert("您已经点过赞了");
                                }
                            }
                        });
                    });
                });
            </script>
        {% endifequal %}

        <div class="row">
            <div class="col-md-10">
                <p class="mcoms">全部评论：</p>
                {% if not comm %}
                    <p style="margin-left: 200px;"> 暂无评论，快来发表你的看法吧！</p>
                {% endif %}
                <ul class="clearfix" id="blog_comms">
                    {% for com in comm %}

                        <li id="com-{{ com.id }}" class="col-md-10">
                            <div class="top">
                                <span class="tou"></span>
                                {#  {% url 'edit_blog' blog.id %}#}
                                <span class="nick"><a
                                        href="{% url 'center:usercenter' com.uses %}">{{ com.uses }}</a></span>

                                <span class="fr"> {{ com.ctime |date:"Y年m月d日 H:i:s" }}</span>

                            </div>

                            <p class="con">{{ com.comms }}
                                {% ifequal com.uses request.user.username %}

                                    <span class="fr">
                                        <a class="a-del" onclick="delComm({{ com.id }})"
                                           href="javascript:">删 除</a>

                                    </span>
                                {% endifequal %}
                            </p>
                        </li>

                    {% endfor %}
                </ul>

            </div>
        </div>
        <script type="text/javascript">
            {#删除自己的评论#}
            $(function () {
                delComm = function (id) {
                    $.ajax({
                        type: "get",
                        url: "{% url 'blog:delcomm' blog.id %}",
                        data: {"id": id},
                        async: true,
                        success: function (data) {
                            //1没有点赞，2点过赞

                            if (data == '1') {
                                alert("删除成功");
                                {#window.location.reload();#}
                                $("#com-"+id).remove();

                                {#$("#blog_comms").load("{{ request.get_host}}{{ request.path}}#blog_comms");#}
                                console.log("{{ request.get_host}}{{ request.path}}#blog_comms")

                            }
                            if (data == '2') {

                                alert("删除失败");
                            }
                        }
                    });
                }
            });
        </script>
        <p class="mcoms">我来评论:</p>
        <div class="comms">


            {% if not request.user.is_authenticated %}
                <div class="gologin">
                    <span class="sp">
                        您暂未登录，请<a href="{% url 'uselogin' %}">登录</a>后再发表评论!
                    </span>
                </div>
            {% else %}

                <form id="form1" action="{% url 'blog:blog_page' blog.id %}" method="post">
                    {% csrf_token %}
                    <input type="hidden" name="blog_id" value="{{ blog.id }}">

                    <textarea class="pcon " name="comment" maxlength="300" required></textarea>

                    <button type="submit" id="sub" class="btn btn-primary pull-right">发表</button>

                </form>
            {% endif %}

        </div>

    </div>
{% endblock %}